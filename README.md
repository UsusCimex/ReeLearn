# ReeLearn

**Сервис для поиска видеофрагментов по описанию.**

## Обзор

Данный проект позволяет пользователям загружать видео, которые затем обрабатываются для извлечения субтитров и таймкодов с использованием модели Whisper от OpenAI. Извлеченные субтитры и таймкоды сохраняются в базе данных PostgreSQL, а обработанные видеофрагменты хранятся в S3-совместимом хранилище (MinIO). Пользователи могут искать определенные фразы или слова, и сервис вернет таймкоды соответствующих видеофрагментов. Затем пользователи могут скачать видеофрагмент и его субтитры.

## Функциональность

- **Загрузка видео**: Пользователи могут загружать видео через эндпоинт `/upload`. Видео обрабатывается для извлечения субтитров и таймкодов с помощью Whisper, и данные сохраняются в PostgreSQL. Обработанное видео сохраняется в MinIO.
- **Поиск**: Пользователи могут искать видеофрагменты по описанию через эндпоинт `/search`. Сервис использует Elasticsearch для полнотекстового поиска по субтитрам и возвращает таймкоды соответствующих фрагментов.
- **Скачивание**: Пользователи могут скачивать видеофрагмент и его субтитры через эндпоинт `/download`. Эндпоинт возвращает URL видео, хранящегося в MinIO, и связанные субтитры.

## Начало работы

### Предварительные требования

- **Docker**: Убедитесь, что Docker установлен на вашей системе.
- **Docker Compose**: Требуется для оркестрации многоконтейнерного приложения.

### Установка

1. **Клонируйте репозиторий**

   ```bash
   git clone https://github.com/yourusername/yourrepository.git
   cd yourrepository
   ```

2. **Настройте переменные окружения**

   Создайте файл `.env` в корневой директории и добавьте следующие переменные:

   ```env
   # PostgreSQL
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=postgres
   POSTGRES_SERVER=db
   POSTGRES_DB=videos

   # MinIO (S3-совместимое хранилище)
   S3_ENDPOINT_URL=http://minio:9000
   S3_ACCESS_KEY=minioadmin
   S3_SECRET_KEY=minioadmin
   S3_BUCKET_NAME=videos

   # Elasticsearch
   ELASTICSEARCH_HOST=elasticsearch
   ELASTICSEARCH_PORT=9200

   # Celery и Redis
   CELERY_BROKER_URL=redis://redis:6379/0
   CELERY_RESULT_BACKEND=redis://redis:6379/0

   # Настройки приложения
   ALLOWED_ORIGINS=http://localhost,http://localhost:3000
   ```

3. **Соберите и запустите сервисы**

   Перейдите в директорию `docker` и выполните команду:

   ```bash
   cd docker
   docker-compose up --build
   ```

   Эта команда соберет образы Docker и запустит контейнеры для бэкенда, базы данных, Redis, MinIO и Elasticsearch.

4. **Примените миграции базы данных**

   В новом окне терминала выполните:

   ```bash
   docker exec -it docker_backend_1 alembic upgrade head
   ```

   Это применит миграции базы данных для настройки схемы PostgreSQL.

## Использование

### Документация API

После запуска приложения вы можете получить доступ к интерактивной документации API по адресу:

```
http://localhost:8000/docs
```

### Эндпоинты

- **Загрузка видео**

  - **Эндпоинт**: `POST /api/v1/upload`
  - **Описание**: Загружает видеофайл для обработки.
  - **Параметры**: Принимает видеофайл в форме данных.
  - **Ответ**: Возвращает ID видео и его название.

- **Поиск по субтитрам**

  - **Эндпоинт**: `POST /api/v1/search`
  - **Описание**: Ищет видеофрагменты по запросу.
  - **Параметры**: JSON-тело, содержащее поисковый запрос.
  - **Ответ**: Возвращает список соответствующих видеофрагментов с таймкодами.

- **Скачивание видеофрагмента**

  - **Эндпоинт**: `GET /api/v1/download/{video_id}`
  - **Описание**: Получает URL видео и субтитры для указанного ID видео.
  - **Параметры**: `video_id` в пути URL.
  - **Ответ**: Возвращает URL видео и связанные субтитры.

## Компоненты проекта

### Бэкенд

- **FastAPI**: Высокопроизводительный веб-фреймворк для создания API.
- **Celery**: Асинхронная очередь задач, используемая для фоновой обработки видеофайлов.
- **Redis**: Хранилище данных в памяти, используемое в качестве брокера сообщений для Celery.
- **PostgreSQL**: Реляционная база данных для хранения метаданных видео и субтитров.
- **Elasticsearch**: Поисковый движок, используемый для полнотекстового поиска по субтитрам.
- **MinIO**: S3-совместимое объектное хранилище для хранения обработанных видеофайлов.
- **Whisper**: Модель от OpenAI, используемая для распознавания речи и генерации субтитров.

### Docker

- **Docker Compose**: Используется для оркестрации и запуска нескольких Docker-контейнеров для приложения и его зависимостей.

## Разработка

### Запуск локально без Docker

Если вы предпочитаете запускать приложение без Docker:

1. **Настройте виртуальное окружение**

   ```bash
   python -m venv venv
   source venv/bin/activate
   ```

2. **Установите зависимости**

   ```bash
   pip install -r backend/requirements.txt
   ```

3. **Настройте переменные окружения**

   Убедитесь, что все необходимые переменные окружения установлены в вашей оболочке или создайте файл `.env`.

4. **Запустите приложение**

   ```bash
   uvicorn backend.main:app --reload
   ```

5. **Запустите Celery worker**

   ```bash
   celery -A backend.workers.celery_app worker --loglevel=info
   ```

## Лицензия

Этот проект лицензируется под лицензией MIT.
